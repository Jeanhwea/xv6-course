#+TITLE: inode 层介绍
#+AUTHOR: Jinghui Hu
#+EMAIL: hujinghui@buaa.edu.cn
#+DATE: <2023-12-03 Sun>
#+STARTUP: overview num indent
#+OPTIONS: ^:nil
#+PROPERTY: header-args:sh :results output :dir ../../study/os/xv6-public


* Block 分配器
1. balloc
2. bfree

* 实现代码分析
1. inode 描述一个匿名的文件
2. 分配
   - ialloc() 分配 inode
   - iput() 当 ref/link count 为零时, 清理 inode
3. iget()/iput()
   - ip->ref 表示 inode 的引用计数
   - iget() 创建 inode, 或者增加 ref
   - iput() 清理 inode
4. 合法性 ip->valid
   - ilock() 从磁盘读取 inode 数据, 并设置 ip->valid=1
   - iput() 当 ip->ref=0 时, 清理 ip->valid

* dinode 数据结构
#+BEGIN_SRC ditaa :file ./img/ditaa-dinode-struct.png :cmdline -E -s 1.5
  dinode
  +---------------+
  |    type       |
  +---------------+
  |    major      |
  +---------------+
  |    minor      |
  +---------------+
  |    nlink      |
  +---------------+
  |    size       |
  +---------------+                       +------+
  |    addr1      |---------------------->| data |
  +---------------+                       +------+
  |     ...       |                       |      |
  +---------------+                       +------+
  |    addr12     |---------------------->| data |
  +---------------+                       +------+
  |   indirect    |                       |      |
  +---------------+                       |      |
        |             indirect data       |      |
        +----------->  +---------+        +------+
                       |  addr1  |------->| data |
                       |---------|        +------+
                       |  ...    |        |      |
                       |---------|        +------+
                       | addr128 |------->| data |
                       +---------+        +------+
#+END_SRC

#+RESULTS:
[[file:./img/ditaa-dinode-struct.png]]
